# 工作流名称
name: GNews Telegram Bot Cron Job

# 触发器配置：计划时间 + 手动触发
on:
  schedule:
    - cron: '5 * * * *'   # 每小时第5分钟运行
  workflow_dispatch:      # 手动触发

# 权限配置：明确授予工作流读写仓库内容的权限
permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
    # 第1步：检出代码
    - name: 1. Checkout repository
      uses: actions/checkout@v4

    # 第2步：设置 Python
    - name: 2. Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # 第3步：缓存 Python 依赖
    - name: 3. Cache Python packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 第4步：安装依赖
    - name: 4. Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 第5步：缓存 Playwright 浏览器内核
    - name: 5. Cache Playwright browsers
      uses: actions/cache@v3
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright
        restore-keys: |
          ${{ runner.os }}-playwright

    # 第6步：安装 Playwright 浏览器及系统依赖
    - name: 6. Install Playwright browsers
      run: playwright install --with-deps

    # 第7步：运行主 Python 脚本
    - name: 7. Run the bot script
      run: python gnews_bot_cn.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}

    # 第8步：提交并推送已发送记录
    - name: 8. Commit and push sent logs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add sent_articles.txt sent_titles.txt
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update sent articles and titles log" && git push)
